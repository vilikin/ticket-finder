(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{153:function(e,t,n){"use strict";n.r(t);var a,r=n(2),i=n.n(r),o=n(30),s=n.n(o),c=(n(67),n(167)),l=n(164),u=n(52),p=n(168),h=n(162),d=n(24),f=n(26),g=n(25),m=n(27),v=n(14),w=n.n(v),b=n(18),x=n(21),k=n(22),y="917849568600-tsfpk9a7ime5mp05mbi2m50pa6dmdvdv.apps.googleusercontent.com",E="AIzaSyC8wpPEEB_lJHis-t6yGkwespbyriKEUas",I=["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"];var C=function e(){var t=this;Object(x.a)(this,e),this.initClient=Object(b.a)(w.a.mark(function e(){var n;return w.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,gapi.client.init({apiKey:E,clientId:y,discoveryDocs:I,scope:"https://www.googleapis.com/auth/gmail.readonly"});case 2:gapi.auth2.getAuthInstance().isSignedIn.listen(t.updateAuthStatus),n=gapi.auth2.getAuthInstance().isSignedIn.get(),t.updateAuthStatus(n);case 5:case"end":return e.stop()}},e,this)})),this.updateAuthStatus=function(e){t.authorized=e,t.callAuthStatusListeners(e)},this.callAuthStatusListeners=function(e){k.forEach(t.authStatusListeners,function(t){return(0,t.callback)(e)})},this.signIn=function(){gapi.auth2.getAuthInstance().signIn()},this.signOut=function(){gapi.auth2.getAuthInstance().signOut()},this.addAuthStatusListener=function(e){var n={id:k.uniqueId(),callback:e};return t.authStatusListeners.push(n),n.id},this.removeAuthStatusListener=function(e){t.authStatusListeners=k.reject(t.authStatusListeners,{id:e})},this.isAuthorized=function(){return t.authorized},this.authStatusListeners=[],this.authorized=!1,gapi.load("client:auth2",this.initClient)};var j=n(54),S=n(48),D=n(163),O=n(166),z=n(31);function A(e){return z(e).format("HH:mm")}var L=function(e){function t(){return Object(x.a)(this,t),Object(f.a)(this,Object(g.a)(t).apply(this,arguments))}return Object(m.a)(t,e),Object(d.a)(t,[{key:"render",value:function(){var e=this.props,t=e.onClick,n=e.tripStartDate,a=e.tripEndDate,r=e.tripStartLocation,o=e.tripEndLocation,s=e.train,l=e.wagon,u=e.seat;return i.a.createElement(c.a,{onClick:t,display:"flex",flexDirection:"row",elevation:"1",padding:8,margin:12,borderBottom:"3px solid #47B881"},i.a.createElement(c.a,{display:"flex",flex:1,alignItems:"center",justifyContent:"center",flexDirection:"column"},i.a.createElement(h.a,{fontWeight:"bold"},r),i.a.createElement(h.a,{size:500},A(n))),i.a.createElement(c.a,{display:"flex",flex:1,alignItems:"center",justifyContent:"center",flexDirection:"column"},i.a.createElement(h.a,{margin:4},z(n).format("DD.MM.YYYY")),i.a.createElement(p.a,{margin:4,icon:"train",color:"#00783E"}),i.a.createElement(h.a,{margin:4},s," / ",l," / ",u)),i.a.createElement(c.a,{display:"flex",flex:1,alignItems:"center",justifyContent:"center",flexDirection:"column"},i.a.createElement(h.a,{fontWeight:"bold"},o),i.a.createElement(h.a,{size:500},A(a))))}}]),t}(r.Component),T=n(56),Q=n(36),R=n(55),U=n(49);function M(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return e.split(t)[a].split(n)[0]}function W(e,t){var n="".concat(t," ").concat(e);return z(n,"DD.MM.YYYY HH:mm").add(3,"hours")}var Y=n(50),q=n.n(Y);function B(){if(!1===gapi.auth2.getAuthInstance().isSignedIn.get())throw new Error("Google API not authenticated")}function H(e){return F.apply(this,arguments)}function F(){return(F=Object(b.a)(w.a.mark(function e(t){var n,a;return w.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,gapi.client.gmail.users.messages.get({userId:"me",id:t});case 2:return n=e.sent,a=U(n.result),e.abrupt("return",a);case 5:case"end":return e.stop()}},e,this)}))).apply(this,arguments)}function G(){return(G=Object(b.a)(w.a.mark(function e(t,n){var a,r,i;return w.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,gapi.client.gmail.users.messages.attachments.get({userId:"me",id:n,messageId:t});case 2:return a=e.sent,r=a.result,i=q.a.toBase64(r.data),e.abrupt("return","data:image/png;base64,".concat(i));case 6:case"end":return e.stop()}},e,this)}))).apply(this,arguments)}function J(){return(J=Object(R.a)(w.a.mark(function e(){var t,n,a,r,i,o,s,c,l;return w.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return B(),e.next=3,Object(Q.a)(gapi.client.gmail.users.messages.list({userId:"me",q:"Matkalippu from:tickets@vr.fi"}));case 3:t=e.sent,n=t.result.messages,a=k.chain(n).map("id").slice(0,4).value(),console.log(a),!1,r=0,i=!1;case 10:if(i||!(r<a.length)){e.next=28;break}return e.prev=11,o=a[r],e.next=15,Object(Q.a)(H(o));case 15:return s=e.sent,c=K(s.textHtml),l=Object(T.a)({},c,{messageId:o,attachmentId:k.first(s.inline).attachmentId}),e.next=20,l;case 20:e.next=25;break;case 22:e.prev=22,e.t0=e.catch(11),console.error("Failed to parse message",e.t0);case 25:r+=1,e.next=10;break;case 28:case"end":return e.stop()}},e,this,[[11,22]])}))).apply(this,arguments)}function K(e){var t=function(e){var t=M(e,'<td width="90%" valign="top" style="color:#4F5D5D;line-height:1.2;" rowspan="1" colspan="1">',"</td>"),n=M(t,'<span style="font-size:16px;">'," </span>"),a=M(t,'<b style="font-size:16px;">'," \u2192</b>");return{time:n,location:a}}(e),n=function(e){var t=M(e,'<td width="90%" style="color:#4F5D5D;padding-top:5px;" rowspan="1" colspan="1">',"</td>"),n=M(t,'<span style="font-size:16px;line-height:1.2;">'," </span>"),a=M(t,'<b style="font-size:16px;line-height:1.2;">',"</b>");return{time:n,location:a}}(e),a=M(e,'<span style="color:#077f00;">',"</span>",2),r=W(t.time,a),i=W(n.time,a),o=M(e,'<span style="font-size:14px;line-height:1.5;">',","),s=M(e,'<b style="font-size:24px;line-height:1.5;color:#077f00;">'," </b>"),c=M(e,'<b style="font-size:24px;line-height:1.5;color:#077f00;">'," </b>",2),l=M(e,'<span style="font-size:16px;">',"</span>",2);return{from:t.location,to:n.location,startDate:r,endDate:i,train:o,wagon:s,seat:c,type:l}}var N,P={findMostRelevantTickets:function(){return J.apply(this,arguments)},getQrCodeDataURI:function(e,t){return G.apply(this,arguments)}},X=function(e){function t(){var e,n;Object(x.a)(this,t);for(var a=arguments.length,r=new Array(a),i=0;i<a;i++)r[i]=arguments[i];return(n=Object(f.a)(this,(e=Object(g.a)(t)).call.apply(e,[this].concat(r)))).state={loading:!0,error:null,tickets:[],showingQrCode:!1,qrCodeDataURI:null},n.showQrCodeDialog=function(){var e=Object(b.a)(w.a.mark(function e(t){var a;return w.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n.setState({showingQrCode:!0}),e.next=3,P.getQrCodeDataURI(t.messageId,t.attachmentId);case 3:a=e.sent,n.setState({qrCodeDataURI:a});case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}(),n.closeQrCodeDialog=Object(b.a)(w.a.mark(function e(){return w.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n.setState({showingQrCode:!1,qrCodeDataURI:null});case 1:case"end":return e.stop()}},e,this)})),n.fetchTickets=Object(b.a)(w.a.mark(function e(){var t,a,r,i,o,s,c;return w.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n.setState({loading:!0,error:null}),e.prev=1,t=!0,a=!1,e.prev=4,i=Object(S.a)(P.findMostRelevantTickets());case 6:return e.next=8,i.next();case 8:return o=e.sent,t=o.done,e.next=12,o.value;case 12:if(s=e.sent,t){e.next=19;break}c=s,n.setState({tickets:Object(j.a)(n.state.tickets).concat([c]),loading:!1,error:null});case 16:t=!0,e.next=6;break;case 19:e.next=25;break;case 21:e.prev=21,e.t0=e.catch(4),a=!0,r=e.t0;case 25:if(e.prev=25,e.prev=26,t||null==i.return){e.next=30;break}return e.next=30,i.return();case 30:if(e.prev=30,!a){e.next=33;break}throw r;case 33:return e.finish(30);case 34:return e.finish(25);case 35:e.next=40;break;case 37:e.prev=37,e.t1=e.catch(1),n.setState({error:e.t1,loading:!1});case 40:case"end":return e.stop()}},e,this,[[1,37],[4,21,25,35],[26,,30,34]])})),n}return Object(m.a)(t,e),Object(d.a)(t,[{key:"componentDidMount",value:function(){var e=Object(b.a)(w.a.mark(function e(){return w.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.fetchTickets();case 2:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"render",value:function(){var e=this,t=this.state,n=t.loading,a=t.error,r=t.tickets,o=t.showingQrCode,s=t.qrCodeDataURI;return n?i.a.createElement(c.a,{display:"flex",alignItems:"center",justifyContent:"center",height:"90vh"},i.a.createElement(D.a,null)):a?i.a.createElement(c.a,null,"Error"):i.a.createElement(c.a,{padding:8},r.map(function(t){return i.a.createElement(L,{tripStartDate:t.startDate,tripStartLocation:t.from,tripEndDate:t.endDate,tripEndLocation:t.to,train:t.train,wagon:t.wagon,seat:t.seat,onClick:function(){return e.showQrCodeDialog({attachmentId:t.attachmentId,messageId:t.messageId})}})}),i.a.createElement(O.a,{isShown:o,title:"Tampere - Tikkurila",onCloseComplete:this.closeQrCodeDialog,hasFooter:!1},i.a.createElement(c.a,{display:"flex",alignItems:"center",justifyContent:"center"},s&&i.a.createElement("img",{src:s,alt:"QR code",height:150,width:150}))))}}]),t}(r.Component),$=(N=function(e){return i.a.createElement(c.a,null,i.a.createElement(c.a,{display:"flex",padding:16,background:"greenTint"},i.a.createElement(c.a,{flex:1,alignItems:"center",display:"flex"},i.a.createElement(l.a,{size:600},"Tickets")),e.authorized?i.a.createElement(u.a,{onClick:e.client.signOut},"Sign out"):i.a.createElement(u.a,{intent:"success",appearance:"primary",onClick:e.client.signIn},"Sign in")),e.authorized?i.a.createElement(X,null):i.a.createElement(c.a,{display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",height:"calc(100vh - 64px)"},i.a.createElement(p.a,{icon:"train",size:60,color:"success"}),i.a.createElement(h.a,{size:30,color:"muted",marginTop:16,marginX:30,align:"center"},"Welcome to Ticket Finder!"),i.a.createElement(h.a,{size:30,color:"muted",marginTop:16,marginX:30,align:"center"},"Sign in with your Google account to find train tickets from your Gmail Inbox.")))},function(e){function t(e){var n;return Object(x.a)(this,t),(n=Object(f.a)(this,Object(g.a)(t).call(this,e))).gmailClient=(a||(a=new C),a),n.state={authorized:n.gmailClient.isAuthorized()},n.gmailClient.addAuthStatusListener(function(e){n.setState({authorized:e})}),n}return Object(m.a)(t,e),Object(d.a)(t,[{key:"render",value:function(){return i.a.createElement(N,{client:this.gmailClient,authorized:this.state.authorized})}}]),t}(i.a.Component)),_=Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));function V(e,t){navigator.serviceWorker.register(e).then(function(e){e.onupdatefound=function(){var n=e.installing;n.onstatechange=function(){"installed"===n.state&&(navigator.serviceWorker.controller?(console.log("New content is available; please refresh."),t.onUpdate&&t.onUpdate(e)):(console.log("Content is cached for offline use."),t.onSuccess&&t.onSuccess(e)))}}}).catch(function(e){console.error("Error during service worker registration:",e)})}s.a.render(i.a.createElement($,null),document.getElementById("root")),function(e){if("serviceWorker"in navigator){if(new URL("/ticket-finder",window.location).origin!==window.location.origin)return;window.addEventListener("load",function(){var t="".concat("/ticket-finder","/service-worker.js");_?(function(e,t){fetch(e).then(function(n){404===n.status||-1===n.headers.get("content-type").indexOf("javascript")?navigator.serviceWorker.ready.then(function(e){e.unregister().then(function(){window.location.reload()})}):V(e,t)}).catch(function(){console.log("No internet connection found. App is running in offline mode.")})}(t,e),navigator.serviceWorker.ready.then(function(){console.log("This web app is being served cache-first by a service worker. To learn more, visit https://goo.gl/SC7cgQ")})):V(t,e)})}}(),window.addEventListener("beforeinstallprompt",function(e){e.prompt()})},62:function(e,t,n){e.exports=n(153)},67:function(e,t,n){}},[[62,2,1]]]);
//# sourceMappingURL=main.63cb0ea5.chunk.js.map