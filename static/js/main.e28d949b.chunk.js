(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{146:function(e,t,n){},148:function(e,t,n){"use strict";n.r(t);var a,r=n(1),i=n.n(r),s=n(48),c=n.n(s),o=(n(62),n(156)),u=n(154),l=n(158),p=n(157),h=n(153),f=n(16),d=n(21),g=n(20),m=n(22),v=n(7),b=n.n(v),w=n(24),x=n(15),E=n(25),k=n(49),y="917849568600-tsfpk9a7ime5mp05mbi2m50pa6dmdvdv.apps.googleusercontent.com",O="AIzaSyC8wpPEEB_lJHis-t6yGkwespbyriKEUas",j=["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"];var C=function e(){var t=this;Object(x.a)(this,e),this.initClient=Object(w.a)(b.a.mark(function e(){var n;return b.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,gapi.client.init({apiKey:O,clientId:y,discoveryDocs:j,scope:"https://www.googleapis.com/auth/gmail.readonly"});case 2:gapi.auth2.getAuthInstance().isSignedIn.listen(t.updateAuthStatus),n=gapi.auth2.getAuthInstance().isSignedIn.get(),t.updateAuthStatus(n);case 5:case"end":return e.stop()}},e,this)})),this.updateAuthStatus=function(e){t.authorized=e,t.callAuthStatusListeners(e)},this.callAuthStatusListeners=function(e){E.forEach(t.authStatusListeners,function(t){return(0,t.callback)(e)})},this.signIn=function(){gapi.auth2.getAuthInstance().signIn()},this.signOut=function(){gapi.auth2.getAuthInstance().signOut()},this.addAuthStatusListener=function(e){var n={id:E.uniqueId(),callback:e};return t.authStatusListeners.push(n),n.id},this.removeAuthStatusListener=function(e){t.authStatusListeners=E.reject(t.authStatusListeners,{id:e})},this.isAuthorized=function(){return t.authorized},this.assertAuthorized=function(){if(!t.isAuthorized())throw new Error("Google API not authenticated")},this.findMessagesByQuery=function(){var e=Object(w.a)(b.a.mark(function e(n){var a,r;return b.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t.assertAuthorized(),e.next=3,gapi.client.gmail.users.messages.list({userId:"me",q:n});case 3:return a=e.sent,r=a.result.messages,e.abrupt("return",r);case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}(),this.getMessageDetails=function(){var e=Object(w.a)(b.a.mark(function e(t){var n,a;return b.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,gapi.client.gmail.users.messages.get({userId:"me",id:t});case 2:return n=e.sent,a=n.result,e.abrupt("return",k(a));case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}(),this.getAttachment=function(){var e=Object(w.a)(b.a.mark(function e(t,n){var a,r;return b.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,gapi.client.gmail.users.messages.attachments.get({userId:"me",id:n,messageId:t});case 2:return a=e.sent,r=a.result,e.abrupt("return",r);case 5:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}(),this.authStatusListeners=[],this.authorized=!1,gapi.load("client:auth2",this.initClient)};function S(e){return function(t){function n(e){var t;return Object(x.a)(this,n),(t=Object(d.a)(this,Object(g.a)(n).call(this,e))).gmailClient=(a||(a=new C),a),t.state={authorized:t.gmailClient.isAuthorized()},t.gmailClient.addAuthStatusListener(function(e){t.setState({authorized:e})}),t}return Object(m.a)(n,t),Object(f.a)(n,[{key:"render",value:function(){return i.a.createElement(e,{client:this.gmailClient,authorized:this.state.authorized})}}]),n}(i.a.Component)}var I=n(52),A=n(50),N=n(23),T=n(34),z=n(35),L=n(53);function D(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return e.split(t)[a].split(n)[0]}function R(e,t){var n="".concat(t," ").concat(e);return N(n,"DD.MM.YYYY HH:mm")}var U=n(51),M=n.n(U),P="true"===new URLSearchParams(window.location.search).get("debug");P&&console.warn("TicketCore is in debug mode!");var B={NON_RELEVANT:"NON_RELEVANT",CURRENT:"CURRENT",UPCOMING:"UPCOMING"},Y="TICKET",F="ERROR",G="NON_RELEVANT";function W(e,t){return{resultType:e,result:t}}var H=function(){function e(t){Object(x.a)(this,e),this.gmailClient=t}return Object(f.a)(e,[{key:"findRelevantTickets",value:function(){var e=this;return Object(L.a)(b.a.mark(function t(){var n,a,r,i,s,c,o,u,l,p,h,f,d,g,m,v;return b.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.gmailClient,t.next=3,Object(z.a)(n.findMessagesByQuery("Matkalippu from:tickets@vr.fi"));case 3:a=t.sent,r=E.map(a,"id"),console.log(r),i=0,s=!0,c=!1,o=void 0,t.prev=10,u=r[Symbol.iterator]();case 12:if(s=(l=u.next()).done){t.next=48;break}return p=l.value,t.prev=14,t.next=17,Object(z.a)(n.getMessageDetails(p));case 17:if(h=t.sent,f=q(h.textHtml),(d=_(f.tripStartDate,f.tripEndDate))!==B.NON_RELEVANT){t.next=30;break}return t.next=23,W(G);case 23:if(console.log("Encountered non-relevant ticket"),2!==i){t.next=27;break}return console.log("Stopping."),t.abrupt("break",48);case 27:return console.log("Stopping if next ticket is also non-relevant"),i++,t.abrupt("continue",45);case 30:return g=E.first(h.inline).attachmentId,t.next=33,Object(z.a)(n.getAttachment(p,g));case 33:return m=t.sent,console.log("Yielding ".concat(d," ticket")),v=Object(T.a)({},f,{id:p,relevancy:d,qrCodeDataURI:V(m.data)}),i=0,t.next=39,W(Y,v);case 39:t.next=45;break;case 41:return t.prev=41,t.t0=t.catch(14),t.next=45,W(F,t.t0);case 45:s=!0,t.next=12;break;case 48:t.next=54;break;case 50:t.prev=50,t.t1=t.catch(10),c=!0,o=t.t1;case 54:t.prev=54,t.prev=55,s||null==u.return||u.return();case 57:if(t.prev=57,!c){t.next=60;break}throw o;case 60:return t.finish(57);case 61:return t.finish(54);case 62:case"end":return t.stop()}},t,this,[[10,50,54,62],[14,41],[55,,57,61]])}))()}}]),e}();function _(e,t){var n=P?N("2018-10-24 08:30"):N();return n.isAfter(t)?B.NON_RELEVANT:n.isBefore(e)?B.UPCOMING:B.CURRENT}function V(e){var t=M.a.toBase64(e);return"data:image/png;base64,".concat(t)}function q(e){var t=function(e){var t=D(e,'<td width="90%" valign="top" style="color:#4F5D5D;line-height:1.2;" rowspan="1" colspan="1">',"</td>"),n=D(t,'<span style="font-size:16px;">'," </span>"),a=D(t,'<b style="font-size:16px;">'," \u2192</b>");return{time:n,location:a}}(e),n=function(e){var t=D(e,'<td width="90%" style="color:#4F5D5D;padding-top:5px;" rowspan="1" colspan="1">',"</td>"),n=D(t,'<span style="font-size:16px;line-height:1.2;">'," </span>"),a=D(t,'<b style="font-size:16px;line-height:1.2;">',"</b>");return{time:n,location:a}}(e),a=D(e,'<span style="color:#077f00;">',"</span>",2),r=R(t.time,a),i=R(n.time,a),s=D(e,'<span style="font-size:14px;line-height:1.5;">',","),c=D(e,'<b style="font-size:24px;line-height:1.5;color:#077f00;">'," </b>"),o=D(e,'<b style="font-size:24px;line-height:1.5;color:#077f00;">'," </b>",2),u=D(e,'<span style="font-size:16px;">',"</span>",2);return{tripStartLocation:t.location,tripEndLocation:n.location,tripStartDate:r,tripEndDate:i,train:s,wagon:c,seat:o,ticketFor:u}}function Q(e){return N(e).format("HH:mm")}var J,K=function(e){function t(){return Object(x.a)(this,t),Object(d.a)(this,Object(g.a)(t).apply(this,arguments))}return Object(m.a)(t,e),Object(f.a)(t,[{key:"render",value:function(){var e=this.props,t=e.onClick,n=e.tripStartDate,a=e.tripEndDate,r=e.tripStartLocation,s=e.tripEndLocation,c=e.train,u=e.wagon,l=e.seat,f=e.relevancy,d=e.qrCodeDataURI;return i.a.createElement(o.a,{onClick:t,display:"flex",flexDirection:"row",elevation:1,padding:8,margin:12,borderBottom:"3px solid ".concat(function(e){switch(e){case B.CURRENT:return"#47B881";case B.UPCOMING:return"#D4EEE2";default:return"#66788A"}}(f))},i.a.createElement(o.a,{display:"flex",flex:1,alignItems:"center",justifyContent:"center",flexDirection:"column"},i.a.createElement(h.a,{fontWeight:"bold"},r),i.a.createElement(h.a,{size:500},Q(n))),i.a.createElement(o.a,{display:"flex",flex:1,alignItems:"center",justifyContent:"center",flexDirection:"column"},i.a.createElement(h.a,{margin:4},N(n).format("DD.MM.YYYY")),f===B.CURRENT?i.a.createElement("img",{src:d,alt:"QR Code",width:133,height:133}):i.a.createElement(p.a,{margin:4,icon:"train",color:"#00783E"}),i.a.createElement(h.a,{margin:4},c," / ",u," / ",l)),i.a.createElement(o.a,{display:"flex",flex:1,alignItems:"center",justifyContent:"center",flexDirection:"column"},i.a.createElement(h.a,{fontWeight:"bold"},s),i.a.createElement(h.a,{size:500},Q(a))))}}]),t}(r.Component);function X(){return J||(J=i.a.createContext()),J}var $=function(e){function t(){var e,n;Object(x.a)(this,t);for(var a=arguments.length,r=new Array(a),i=0;i<a;i++)r[i]=arguments[i];return(n=Object(d.a)(this,(e=Object(g.a)(t)).call.apply(e,[this].concat(r)))).state={loading:!1,progress:0},n.setLoading=function(e){n.setState({loading:e,progress:e?0:1})},n.setProgress=function(e){n.setState({progress:e})},n}return Object(m.a)(t,e),Object(f.a)(t,[{key:"render",value:function(){var e=X();return i.a.createElement(e.Provider,{value:Object(T.a)({},this.state,{setLoading:this.setLoading,setProgress:this.setProgress})},this.props.children)}}]),t}(i.a.Component),Z=2,ee=X();var te=function(e){function t(e){var n;return Object(x.a)(this,t),(n=Object(d.a)(this,Object(g.a)(t).call(this,e))).ticketFinder=new H(e.client),n.state={error:null,tickets:[]},n}return Object(m.a)(t,e),Object(f.a)(t,[{key:"componentDidMount",value:function(){var e=Object(w.a)(b.a.mark(function e(){var t,n,a,r,i,s,c,o,u,l,p,h,f,d;return b.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=this.context,n=t.setLoading,a=t.setProgress,n(!0),r=0,i=0,s=!0,c=!1,e.prev=6,u=Object(A.a)(this.ticketFinder.findRelevantTickets());case 8:return e.next=10,u.next();case 10:return l=e.sent,s=l.done,e.next=14,l.value;case 14:if(p=e.sent,s){e.next=25;break}f=(h=p).resultType,d=h.result,f===Y&&this.setState({tickets:Object(I.a)(this.state.tickets).concat([d])}),f===F&&r++,a((g=++i)/(Z>g?Z:g+1));case 22:s=!0,e.next=8;break;case 25:e.next=31;break;case 27:e.prev=27,e.t0=e.catch(6),c=!0,o=e.t0;case 31:if(e.prev=31,e.prev=32,s||null==u.return){e.next=36;break}return e.next=36,u.return();case 36:if(e.prev=36,!c){e.next=39;break}throw o;case 39:return e.finish(36);case 40:return e.finish(31);case 41:a(1),setTimeout(function(){return n(!1)},500),console.log("Finished fetching relevant tickets with ".concat(r," error(s)."));case 44:case"end":return e.stop()}var g},e,this,[[6,27,31,41],[32,,36,40]])}));return function(){return e.apply(this,arguments)}}()},{key:"render",value:function(){var e=this.state.tickets;return i.a.createElement(o.a,{marginX:8,marginTop:2},e.map(function(e){return i.a.createElement(K,Object.assign({key:e.id},e))}))}}]),t}(r.Component);te.contextType=ee;var ne=S(te),ae=(n(146),n(33)),re=n.n(ae),ie=X(),se=function(e){function t(){return Object(x.a)(this,t),Object(d.a)(this,Object(g.a)(t).apply(this,arguments))}return Object(m.a)(t,e),Object(f.a)(t,[{key:"render",value:function(){var e=this.context,t=e.loading,n=(100*e.progress).toFixed(0),a=re()("progress-bar",{visible:t});return i.a.createElement("div",{className:a},i.a.createElement("div",{className:"fill",style:{width:"".concat(n,"%")}}))}}]),t}(i.a.Component);se.contextType=ie;var ce=se,oe=S(function(e){return i.a.createElement(o.a,null,i.a.createElement(o.a,{display:"flex",padding:16,background:"greenTint"},i.a.createElement(o.a,{flex:1,alignItems:"center",display:"flex"},i.a.createElement(u.a,{size:600},"Tickets")),e.authorized?i.a.createElement(l.a,{onClick:e.client.signOut},"Sign out"):i.a.createElement(l.a,{intent:"success",appearance:"primary",onClick:e.client.signIn},"Sign in")),i.a.createElement(ce,null),e.authorized?i.a.createElement(ne,null):i.a.createElement(o.a,{display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",height:"calc(100vh - 64px)"},i.a.createElement(p.a,{icon:"train",size:60,color:"success"}),i.a.createElement(h.a,{color:"muted",marginTop:16,marginX:30,align:"center"},"Welcome to Ticket Finder!"),i.a.createElement(h.a,{color:"muted",marginTop:16,marginX:30,align:"center"},"Sign in with your Google account to find train tickets from your Gmail Inbox.")))}),ue=Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));function le(e,t){navigator.serviceWorker.register(e).then(function(e){e.onupdatefound=function(){var n=e.installing;n.onstatechange=function(){"installed"===n.state&&(navigator.serviceWorker.controller?(console.log("New content is available; please refresh."),t.onUpdate&&t.onUpdate(e)):(console.log("Content is cached for offline use."),t.onSuccess&&t.onSuccess(e)))}}}).catch(function(e){console.error("Error during service worker registration:",e)})}c.a.render(i.a.createElement($,null,i.a.createElement(oe,null)),document.getElementById("root")),function(e){if("serviceWorker"in navigator){if(new URL("/ticket-finder",window.location).origin!==window.location.origin)return;window.addEventListener("load",function(){var t="".concat("/ticket-finder","/service-worker.js");ue?(function(e,t){fetch(e).then(function(n){404===n.status||-1===n.headers.get("content-type").indexOf("javascript")?navigator.serviceWorker.ready.then(function(e){e.unregister().then(function(){window.location.reload()})}):le(e,t)}).catch(function(){console.log("No internet connection found. App is running in offline mode.")})}(t,e),navigator.serviceWorker.ready.then(function(){console.log("This web app is being served cache-first by a service worker. To learn more, visit https://goo.gl/SC7cgQ")})):le(t,e)})}}(),window.addEventListener("beforeinstallprompt",function(e){e.prompt()})},57:function(e,t,n){e.exports=n(148)},62:function(e,t,n){}},[[57,2,1]]]);
//# sourceMappingURL=main.e28d949b.chunk.js.map