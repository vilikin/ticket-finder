(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{146:function(e,t,n){"use strict";n.r(t);var a,r=n(1),i=n.n(r),s=n(46),c=n.n(s),o=(n(62),n(156)),u=n(153),l=n(154),p=n(157),h=n(151),f=n(19),d=n(25),g=n(24),m=n(26),v=n(7),b=n.n(v),w=n(21),k=n(18),x=n(22),E=n(47),y="917849568600-tsfpk9a7ime5mp05mbi2m50pa6dmdvdv.apps.googleusercontent.com",O="AIzaSyC8wpPEEB_lJHis-t6yGkwespbyriKEUas",j=["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"];var C=function e(){var t=this;Object(k.a)(this,e),this.initClient=Object(w.a)(b.a.mark(function e(){var n;return b.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,gapi.client.init({apiKey:O,clientId:y,discoveryDocs:j,scope:"https://www.googleapis.com/auth/gmail.readonly"});case 2:gapi.auth2.getAuthInstance().isSignedIn.listen(t.updateAuthStatus),n=gapi.auth2.getAuthInstance().isSignedIn.get(),t.updateAuthStatus(n);case 5:case"end":return e.stop()}},e,this)})),this.updateAuthStatus=function(e){t.authorized=e,t.callAuthStatusListeners(e)},this.callAuthStatusListeners=function(e){x.forEach(t.authStatusListeners,function(t){return(0,t.callback)(e)})},this.signIn=function(){gapi.auth2.getAuthInstance().signIn()},this.signOut=function(){gapi.auth2.getAuthInstance().signOut()},this.addAuthStatusListener=function(e){var n={id:x.uniqueId(),callback:e};return t.authStatusListeners.push(n),n.id},this.removeAuthStatusListener=function(e){t.authStatusListeners=x.reject(t.authStatusListeners,{id:e})},this.isAuthorized=function(){return t.authorized},this.assertAuthorized=function(){if(!t.isAuthorized())throw new Error("Google API not authenticated")},this.findMessagesByQuery=function(){var e=Object(w.a)(b.a.mark(function e(n){var a,r;return b.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t.assertAuthorized(),e.next=3,gapi.client.gmail.users.messages.list({userId:"me",q:n});case 3:return a=e.sent,r=a.result.messages,e.abrupt("return",r);case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}(),this.getMessageDetails=function(){var e=Object(w.a)(b.a.mark(function e(t){var n,a;return b.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,gapi.client.gmail.users.messages.get({userId:"me",id:t});case 2:return n=e.sent,a=n.result,e.abrupt("return",E(a));case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}(),this.getAttachment=function(){var e=Object(w.a)(b.a.mark(function e(t,n){var a,r;return b.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,gapi.client.gmail.users.messages.attachments.get({userId:"me",id:n,messageId:t});case 2:return a=e.sent,r=a.result,e.abrupt("return",r);case 5:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}(),this.authStatusListeners=[],this.authorized=!1,gapi.load("client:auth2",this.initClient)};function S(e){return function(t){function n(e){var t;return Object(k.a)(this,n),(t=Object(d.a)(this,Object(g.a)(n).call(this,e))).gmailClient=(a||(a=new C),a),t.state={authorized:t.gmailClient.isAuthorized()},t.gmailClient.addAuthStatusListener(function(e){t.setState({authorized:e})}),t}return Object(m.a)(n,t),Object(f.a)(n,[{key:"render",value:function(){return i.a.createElement(e,{client:this.gmailClient,authorized:this.state.authorized})}}]),n}(i.a.Component)}var I=n(51),A=n(48),z=n(152),D=n(20),N=n(53),L=n(33),R=n(52);function T(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return e.split(t)[a].split(n)[0]}function U(e,t){var n="".concat(t," ").concat(e);return D(n,"DD.MM.YYYY HH:mm")}var M=n(49),B=n.n(M),Y="true"===new URLSearchParams(window.location.search).get("debug");Y&&console.warn("TicketCore is in debug mode!");var F={NON_RELEVANT:"NON_RELEVANT",CURRENT:"CURRENT",UPCOMING:"UPCOMING"},G=function(){function e(t){Object(k.a)(this,e),this.gmailClient=t}return Object(f.a)(e,[{key:"findRelevantTickets",value:function(){var e=this;return Object(R.a)(b.a.mark(function t(){var n,a,r,i,s,c,o,u,l,p,h,f,d,g,m;return b.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.gmailClient,t.next=3,Object(L.a)(n.findMessagesByQuery("Matkalippu from:tickets@vr.fi"));case 3:a=t.sent,r=x.map(a,"id"),console.log(r),i=!1,s=!0,c=!1,o=void 0,t.prev=10,u=r[Symbol.iterator]();case 12:if(s=(l=u.next()).done){t.next=45;break}return p=l.value,t.prev=14,t.next=17,Object(L.a)(n.getMessageDetails(p));case 17:if(h=t.sent,f=H(h.textHtml),(d=W(f.tripStartDate,f.tripEndDate))!==F.NON_RELEVANT){t.next=28;break}if(console.log("Encountered non-relevant ticket"),!i){t.next=25;break}return console.log("Stopping."),t.abrupt("break",45);case 25:return console.log("Stopping if next ticket is also non-relevant"),i=!0,t.abrupt("continue",42);case 28:return g=x.first(h.inline).attachmentId,t.next=31,Object(L.a)(n.getAttachment(p,g));case 31:return m=t.sent,console.log("Yielding ".concat(d," ticket")),t.next=35,Object(N.a)({},f,{id:p,relevancy:d,qrCodeDataURI:P(m.data)});case 35:t.next=42;break;case 37:return t.prev=37,t.t0=t.catch(14),console.error("Failed to parse message",t.t0),t.next=42,t.t0;case 42:s=!0,t.next=12;break;case 45:t.next=51;break;case 47:t.prev=47,t.t1=t.catch(10),c=!0,o=t.t1;case 51:t.prev=51,t.prev=52,s||null==u.return||u.return();case 54:if(t.prev=54,!c){t.next=57;break}throw o;case 57:return t.finish(54);case 58:return t.finish(51);case 59:case"end":return t.stop()}},t,this,[[10,47,51,59],[14,37],[52,,54,58]])}))()}}]),e}();function W(e,t){var n=Y?D("2018-10-24 08:30"):D();return n.isAfter(t)?F.NON_RELEVANT:n.isBefore(e)?F.UPCOMING:F.CURRENT}function P(e){var t=B.a.toBase64(e);return"data:image/png;base64,".concat(t)}function H(e){var t=function(e){var t=T(e,'<td width="90%" valign="top" style="color:#4F5D5D;line-height:1.2;" rowspan="1" colspan="1">',"</td>"),n=T(t,'<span style="font-size:16px;">'," </span>"),a=T(t,'<b style="font-size:16px;">'," \u2192</b>");return{time:n,location:a}}(e),n=function(e){var t=T(e,'<td width="90%" style="color:#4F5D5D;padding-top:5px;" rowspan="1" colspan="1">',"</td>"),n=T(t,'<span style="font-size:16px;line-height:1.2;">'," </span>"),a=T(t,'<b style="font-size:16px;line-height:1.2;">',"</b>");return{time:n,location:a}}(e),a=T(e,'<span style="color:#077f00;">',"</span>",2),r=U(t.time,a),i=U(n.time,a),s=T(e,'<span style="font-size:14px;line-height:1.5;">',","),c=T(e,'<b style="font-size:24px;line-height:1.5;color:#077f00;">'," </b>"),o=T(e,'<b style="font-size:24px;line-height:1.5;color:#077f00;">'," </b>",2),u=T(e,'<span style="font-size:16px;">',"</span>",2);return{tripStartLocation:t.location,tripEndLocation:n.location,tripStartDate:r,tripEndDate:i,train:s,wagon:c,seat:o,ticketFor:u}}function _(e){return D(e).format("HH:mm")}var q=function(e){function t(){return Object(k.a)(this,t),Object(d.a)(this,Object(g.a)(t).apply(this,arguments))}return Object(m.a)(t,e),Object(f.a)(t,[{key:"render",value:function(){var e=this.props,t=e.onClick,n=e.tripStartDate,a=e.tripEndDate,r=e.tripStartLocation,s=e.tripEndLocation,c=e.train,u=e.wagon,l=e.seat,f=e.relevancy,d=e.qrCodeDataURI;return i.a.createElement(o.a,{onClick:t,display:"flex",flexDirection:"row",elevation:1,padding:8,margin:12,borderBottom:"3px solid ".concat(function(e){switch(e){case F.CURRENT:return"#47B881";case F.UPCOMING:return"#D4EEE2";default:return"#66788A"}}(f))},i.a.createElement(o.a,{display:"flex",flex:1,alignItems:"center",justifyContent:"center",flexDirection:"column"},i.a.createElement(h.a,{fontWeight:"bold"},r),i.a.createElement(h.a,{size:500},_(n))),i.a.createElement(o.a,{display:"flex",flex:1,alignItems:"center",justifyContent:"center",flexDirection:"column"},i.a.createElement(h.a,{margin:4},D(n).format("DD.MM.YYYY")),f===F.CURRENT?i.a.createElement("img",{src:d,alt:"QR Code",width:133,height:133}):i.a.createElement(p.a,{margin:4,icon:"train",color:"#00783E"}),i.a.createElement(h.a,{margin:4},c," / ",u," / ",l)),i.a.createElement(o.a,{display:"flex",flex:1,alignItems:"center",justifyContent:"center",flexDirection:"column"},i.a.createElement(h.a,{fontWeight:"bold"},s),i.a.createElement(h.a,{size:500},_(a))))}}]),t}(r.Component),Q=S(function(e){function t(e){var n;return Object(k.a)(this,t),(n=Object(d.a)(this,Object(g.a)(t).call(this,e))).ticketFinder=new G(e.client),n.state={loading:!0,error:null,tickets:[]},n}return Object(m.a)(t,e),Object(f.a)(t,[{key:"componentDidMount",value:function(){var e=Object(w.a)(b.a.mark(function e(){var t,n,a,r,i,s,c,o;return b.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=0,n=!0,a=!1,e.prev=3,i=Object(A.a)(this.ticketFinder.findRelevantTickets());case 5:return e.next=7,i.next();case 7:return s=e.sent,n=s.done,e.next=11,s.value;case 11:if(c=e.sent,n){e.next=21;break}if(!((o=c)instanceof Error)){e.next=17;break}return t++,e.abrupt("continue",18);case 17:this.setState({tickets:Object(I.a)(this.state.tickets).concat([o]),loading:!1});case 18:n=!0,e.next=5;break;case 21:e.next=27;break;case 23:e.prev=23,e.t0=e.catch(3),a=!0,r=e.t0;case 27:if(e.prev=27,e.prev=28,n||null==i.return){e.next=32;break}return e.next=32,i.return();case 32:if(e.prev=32,!a){e.next=35;break}throw r;case 35:return e.finish(32);case 36:return e.finish(27);case 37:console.log("Finished fetching relevant tickets with ".concat(t," error(s)."));case 38:case"end":return e.stop()}},e,this,[[3,23,27,37],[28,,32,36]])}));return function(){return e.apply(this,arguments)}}()},{key:"render",value:function(){var e=this.state,t=e.loading,n=e.tickets;return t?i.a.createElement(o.a,{display:"flex",alignItems:"center",justifyContent:"center",height:"90vh"},i.a.createElement(z.a,null)):i.a.createElement(o.a,{padding:8},n.map(function(e){return i.a.createElement(q,Object.assign({key:e.id},e))}))}}]),t}(r.Component)),V=S(function(e){return i.a.createElement(o.a,null,i.a.createElement(o.a,{display:"flex",padding:16,background:"greenTint"},i.a.createElement(o.a,{flex:1,alignItems:"center",display:"flex"},i.a.createElement(u.a,{size:600},"Tickets")),e.authorized?i.a.createElement(l.a,{onClick:e.client.signOut},"Sign out"):i.a.createElement(l.a,{intent:"success",appearance:"primary",onClick:e.client.signIn},"Sign in")),e.authorized?i.a.createElement(Q,null):i.a.createElement(o.a,{display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",height:"calc(100vh - 64px)"},i.a.createElement(p.a,{icon:"train",size:60,color:"success"}),i.a.createElement(h.a,{color:"muted",marginTop:16,marginX:30,align:"center"},"Welcome to Ticket Finder!"),i.a.createElement(h.a,{color:"muted",marginTop:16,marginX:30,align:"center"},"Sign in with your Google account to find train tickets from your Gmail Inbox.")))}),J=Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));function K(e,t){navigator.serviceWorker.register(e).then(function(e){e.onupdatefound=function(){var n=e.installing;n.onstatechange=function(){"installed"===n.state&&(navigator.serviceWorker.controller?(console.log("New content is available; please refresh."),t.onUpdate&&t.onUpdate(e)):(console.log("Content is cached for offline use."),t.onSuccess&&t.onSuccess(e)))}}}).catch(function(e){console.error("Error during service worker registration:",e)})}c.a.render(i.a.createElement(V,null),document.getElementById("root")),function(e){if("serviceWorker"in navigator){if(new URL("/ticket-finder",window.location).origin!==window.location.origin)return;window.addEventListener("load",function(){var t="".concat("/ticket-finder","/service-worker.js");J?(function(e,t){fetch(e).then(function(n){404===n.status||-1===n.headers.get("content-type").indexOf("javascript")?navigator.serviceWorker.ready.then(function(e){e.unregister().then(function(){window.location.reload()})}):K(e,t)}).catch(function(){console.log("No internet connection found. App is running in offline mode.")})}(t,e),navigator.serviceWorker.ready.then(function(){console.log("This web app is being served cache-first by a service worker. To learn more, visit https://goo.gl/SC7cgQ")})):K(t,e)})}}(),window.addEventListener("beforeinstallprompt",function(e){e.prompt()})},57:function(e,t,n){e.exports=n(146)},62:function(e,t,n){}},[[57,2,1]]]);
//# sourceMappingURL=main.bedebe28.chunk.js.map